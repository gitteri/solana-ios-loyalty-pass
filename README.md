# Solana Loyalty Pass

Welcome to the Solana Loyalty Pass project! This application allows you to create and manage Apple Wallet passes for your loyalty program using the Solana blockchain. It's built with Next.js and integrates with Solana for secure and efficient pass management.

## Table of Contents
1. [Introduction](#introduction)
2. [How Loyalty Passes Work](#how-loyalty-passes-work)
3. [Prerequisites](#prerequisites)
4. [Installation](#installation)
5. [Setting up the server-files Directory](#setting-up-the-server-files-directory)
6. [Running the Application](#running-the-application)
7. [Project Structure](#project-structure)
8. [Key Features](#key-features)
9. [Troubleshooting](#troubleshooting)
10. [Contributing](#contributing)
11. [Learn More](#learn-more)

## Introduction

Solana Loyalty Pass is a web application that combines the power of blockchain technology with digital loyalty programs. It allows businesses to create, distribute, and manage loyalty passes that can be added to Apple Wallet. This sample application is intended to be used as a starting point for your own loyalty program and uses an insecure embedded wallet for simplicity. By leveraging Solana's fast and cost-effective blockchain, the application ensures secure and transparent management of loyalty points.

## How Loyalty Passes Work

The Solana Loyalty Pass system utilizes a combination of blockchain technology and cryptographic techniques to ensure secure and user-friendly loyalty pass management. Here's a detailed breakdown of how it works:

### Sign-in with Solana Integration

1. When creating a pass, the application embeds the user wallet signed "Sign in with Solana" data into the QR code.
2. This data includes a unique nonce generated by the application backend to prevent double-spending and man-in-the-middle attacks.

### QR Code Verification

During redemption, the application verifies the data in the QR code to ensure:
- The end user has ownership over the relevant wallet.
- The pass hasn't been used before (using the nonce). Note this feature is not yet implemented due to not having a database to track pass usage but should be trivial to implement.

This verification process adds an extra layer of security and prevents unauthorized use of loyalty passes.

### Permanent Delegate Feature

The system leverages the "permanent delegate" feature of token extensions to enable a seamless redemption process:
- Users don't need to sign a transaction during redemption, reducing friction.
- The application can initiate the redemption process on behalf of the user.
- Despite this convenience, the permanent delegate cannot redeem tokens without the end user's permission, maintaining security.

### Future Enhancements

To further improve the system, you can implement:
- A custom permanent delegate authority program at the Solana program level.
- This program would verify end user approval to pull funds from their account.

Benefits of this enhancement:
- Reduced friction in the redemption process.
- Increased security by requiring user approval at the program level.
- Improved end user experience with a balance of convenience and control.

By combining these features, the Solana Loyalty Pass system offers a secure, efficient, and user-friendly solution for managing digital loyalty programs on the blockchain.


## Prerequisites

Before you begin, ensure you have the following installed on your system:
- Node.js (version 14 or later)
- npm (usually comes with Node.js)
- Git (for version control and cloning the repository)

You'll also need a basic understanding of JavaScript and React, as the project is built with Next.js, a React framework.

## Installation

Follow these steps to set up the project on your local machine:

1. Clone the repository:
   ```
   git clone https://github.com/your-username/solana-loyalty-pass.git
   ```

2. Navigate to the project directory:
   ```
   cd solana-loyalty-pass
   ```

3. Install the dependencies:
   ```
   npm install
   ```

4. Create a `.env.local` file in the root of the project and add the following:
   ```
   NEXT_PUBLIC_HELIUS_API_KEY=<your-helius-api-key>
   ```

## Setting up the server-files Directory

The `server-files` directory contains important files for pass generation and management. Follow these steps to set it up:

1. Create the following subdirectories in the `server-files` directory:
   ```
   mkdir -p server-files/certs server-files/issuer server-files/solana.pass server-files/token
   ```

2. Set up the `certs` directory:
   - Place your Apple Pass certificates in this directory. You'll need:
     - `pass.cer`: Your pass type certificate
     - `pass.key`: Your private key
     - `wwdr.pem`: Apple's WWDR certificate
   - More details on how to generate these can be found [here](https://github.com/alexandercerutti/passkit-generator/wiki/Generating-Certificates).

3. Set up the `issuer` directory:
   - Generate a Solana keypair for the issuer and save it as `issuer.json` in this directory.
   - You can use the Solana CLI to generate this keypair:
     ```
     solana-keygen new --outfile server-files/issuer/issuer.json
     ```

4. Set up the `solana.pass` directory:
   - This directory will contain your Apple Wallet pass template files.
   - Create a `pass.json` file with the basic structure of your pass. For example:
     ```json
     {
       "formatVersion": 1,
       "passTypeIdentifier": "pass.com.your-company.loyalty",
       "serialNumber": "solanaaddress",
       "teamIdentifier": "YOUR_TEAM_ID",
       "organizationName": "Your Company Name",
       "description": "Loyalty Pass"
     }
     ```
   - Add any necessary images for your pass (icon.png, logo.png, etc.) to this directory.

5. The `token` directory:
   - This directory will remain empty initially. It will be used to store details about the loyalty token when it's created.

## Running the Application

To start the development server:

1. Run the following command:
   ```
   next dev
   ```

2. Open your web browser and navigate to `http://localhost:3000`

You should now see the Solana Loyalty Pass application running on your local machine! Note that the application does the following to make getting started easier:
* Automatically creates an embedded wallet for the user. This wallet is not secure and should not be used for anything else than this sample application.
* Automatically airdrops SOL to the user's wallet.
* Automatically airdrops SOL to the issuer's wallet.
* Automatically updates balances for the wallets every 10 seconds.

## Project Structure

Here's a brief overview of the important directories and files in the project:

- `/app`: Contains the main application code
  - `/api`: API routes for server-side operations
  - `/context`: React context providers for state management
  - `/utils`: Utility functions for the application
  - `/services`: Service for interacting with a Solana RPC node (currently configured for Helius but can be changed to any RPC node provider)
  - `/*`: Other Next.js pages and routing
- `/public`: Static assets like images and fonts
- `/server-files`: Server-side files for pass generation and management
  - `/certs`: Apple Pass certificates
  - `/issuer`: Issuer Solana keypair
  - `/solana.pass`: Apple Wallet pass template files
  - `/token`: Storage for loyalty token details

## Key Features

1. **Wallet Creation**: Users can create a Solana wallet within the application.
2. **Token Management**: Create and manage your loyalty tokens on the Solana blockchain.
3. **Pass Creation**: Design and generate Apple Wallet passes for your loyalty program.
4. **Pass Distribution**: Easily distribute passes to your customers.
5. **Balance Management**: Track and update loyalty point balances on the blockchain.

## Troubleshooting

If you encounter any issues while setting up or running the application, try the following:

1. Ensure all dependencies are installed correctly by running `npm install` again.
2. Verify that the `server-files` directory is set up correctly with all necessary subdirectories and files.
3. Check that your Apple Pass certificates are valid and placed in the correct location.
4. Clear your browser cache and restart the development server.
5. Check the console for any error messages and search for solutions online.
6. If the issue persists, please open an issue on the GitHub repository.

## Contributing

We welcome contributions to the Solana Loyalty Pass project! If you'd like to contribute:

1. Fork the repository
2. Create a new branch for your feature or bug fix
3. Make your changes and commit them with clear, descriptive messages
4. Push your changes to your fork
5. Create a pull request to the main repository

Please ensure your code follows the project's coding standards and includes appropriate tests.

## Learn More

To deepen your understanding of the technologies used in this project, check out these resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Solana Documentation](https://docs.solana.com/) - explore Solana blockchain concepts and development.
- [React Documentation](https://reactjs.org/docs/getting-started.html) - get started with React.
- [Apple Wallet Developer Guide](https://developer.apple.com/wallet/) - learn about creating passes for Apple Wallet.
- [Author's Twitter](https://twitter.com/nocircuit) - ask questions or share feedback.

Happy coding, and enjoy building with Solana Loyalty Pass!
